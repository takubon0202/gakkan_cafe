# 08_inventory.md - 在庫管理エージェント v2.0

## エージェント概要

| 項目 | 内容 |
|------|------|
| 役割 | 在庫管理システムの構築・保守 |
| 入力 | スプレッドシートURL、在庫データ構造 |
| 出力 | GASスクリプト、在庫表示UI |
| 責任範囲 | Google Spreadsheet連携、在庫状況の可視化 |
| バージョン | 2.0 |

## 対象スプレッドシート

- **URL**: https://docs.google.com/spreadsheets/d/1ulBqzA_lS_J7eJeR2u0t5Mzkzyj-Z4BH-f9XRVBf9T4/edit
- **メインデータソース**: `在庫管理`シート（v2.0で変更）
- **シート構成**:
  - `在庫管理`: **メイン在庫リスト**（商品名、仕入れ状況、残数、理想残数、初期仕入れ数、仕入れライン）
  - `在庫管理場所`: 保管場所情報（オプション）
  - `入力確認１`: 入力履歴（未使用）
  - `在庫数・発注`: 旧データソース（v1.0、非推奨）

## 在庫管理シート列構造

| 列 | インデックス | フィールド名 | 説明 | 例 |
|----|-------------|--------------|------|-----|
| A | 0 | name | 仕入れ品（商品名） | コーヒー豆（シティーローストブラジル） |
| B | 1 | purchaseStatus | 仕入れ状況 | 完了 |
| C | 2 | remaining | 残数 | 2500 |
| D | 3 | ideal | 理想残数 | 2000 |
| E | 4 | initial | 初期仕入れ数 | 3000 |
| F | 5 | orderLine | 仕入れライン（発注点） | 1000 |
| G〜 | 6〜 | - | 仕入れ日と数（履歴） | - |

## 発注判定ロジック v2.3

```javascript
// v2.3: 仕入れ状況ベースの判定（残数/仕入れラインではなく「仕入れ状況」列で判定）
const purchaseStatus = String(row[1] || '').trim();
const needsOrder = purchaseStatus === '未申請';        // 赤表示
const inProgress = purchaseStatus === '仕入れ申請中';  // オレンジ表示
const isCompleted = purchaseStatus === '完了';          // 緑表示

// statusType: 'pending'(未申請), 'in_progress'(申請中), 'completed'(完了)
let statusType = 'completed';
if (needsOrder) statusType = 'pending';
else if (inProgress) statusType = 'in_progress';

// 在庫率 = 残数 / 理想残数 × 100
const stockRatio = ideal > 0 ? Math.round((remaining / ideal) * 100) : 100;
```

## 技術仕様

### GAS（Google Apps Script）v2.0

1. **doGet関数**: Web APIとしてJSONを返す
2. **読み取り専用**: 編集機能は提供しない
3. **カテゴリ自動分類**: 商品名からカテゴリを推測
4. **在庫率計算**: 理想残数に対する割合を算出
5. **発注リスト生成**: 発注が必要なアイテムを別配列で提供

### カテゴリ分類ルール v2.1

```javascript
const CATEGORY_RULES = {
  'コーヒー': ['コーヒー豆', 'エスプレッソ'],
  '乳製品・冷蔵': ['牛乳', 'ホイップクリーム', 'ミルク', '氷'],
  'シロップ・ソース': ['チョコソース', 'キャラメルソース', 'バニラシロップ', 'チャイシロップ', 'ホワイトチョコソース'],
  'パウダー・茶葉': ['抹茶パウダー', 'ほうじ茶パウダー', 'アールグレイ'],
  '消耗品（容器）': ['紙カップ', 'フタ', 'プラカップ', 'プラフタ', 'マドラー', 'ストロー'],
  '消耗品（調味料）': ['シュガー', 'ガムシロップ'],
  '衛生・清掃用品': ['手袋', '消毒液', 'アルコール', 'ペーパータオル', 'スポンジ', '洗剤'],
  'その他': []
};
```

### フロントエンド

1. **在庫一覧表示**: カテゴリ別にグループ化
2. **発注アラートセクション**: 発注が必要なアイテムを先頭に表示
3. **在庫率バー**: 残数/理想残数の割合を視覚化
4. **3段階ステータス**: OK（緑）、残少（黄）、要発注（赤）
5. **API接続ステータス表示**: リアルタイムで接続状態を視覚的に表示

### API接続ステータス機能

ページヘッダーに接続状態をリアルタイム表示:

| ステータス | インジケータ | 意味 |
|-----------|-------------|------|
| `connected` | 緑（点滅） | API正常接続中 |
| `checking` | オレンジ（点滅） | 接続確認中 |
| `cached` | 青 | キャッシュデータ使用中 |
| `offline` | 赤 | 接続エラー |
| `unconfigured` | グレー | API未設定（デモデータ） |

## データ構造 v2.0

### 在庫アイテム（v2.3形式）
```javascript
{
  name: "コーヒー豆（シティーローストブラジル）",
  category: "コーヒー",           // 自動分類
  remaining: 2500,                // 残数
  ideal: 2000,                    // 理想残数
  initial: 3000,                  // 初期仕入れ数
  orderLine: 1000,                // 仕入れライン（発注点）
  purchaseStatus: "完了",         // 仕入れ状況（完了/未申請/仕入れ申請中）
  status: "完了",                 // 表示用ステータス
  statusType: "completed",        // v2.3: 'completed', 'pending', 'in_progress'
  needsOrder: false,              // 未申請フラグ
  inProgress: false,              // v2.3: 仕入れ申請中フラグ
  stockRatio: 125,                // 在庫率（%）
  unit: "g"                       // 単位（自動推測）
}
```

### APIレスポンス構造（v2.3）
```javascript
{
  success: true,
  timestamp: "2025-12-30T01:30:00.000Z",
  version: "2.3",
  summary: {
    totalItems: 28,
    needsOrder: 5,       // 未申請の数
    inProgress: 5,       // 仕入れ申請中の数
    completed: 18        // 完了の数
  },
  items: [...],           // 全在庫アイテム
  categories: {...},      // カテゴリ別グループ（仕入れ状況優先ソート済み）
  orderList: [...],       // 未申請アイテムリスト（赤表示）
  inProgressList: [...],  // v2.3: 仕入れ申請中アイテムリスト（オレンジ表示）
  storage: [...]          // 保管場所情報
}
```

### 保管情報
```javascript
{
  name: "チョコソース",
  beforeOpen: "常温",
  afterOpen: "閉店時：冷蔵庫\n開店時：常温",
  location: "",
  expiryDays: "1か月",
  notes: "注ぎ口を清潔に"
}
```

## UI設計 v2.0

### 在庫管理ページ構成

1. **ヘッダー**
   - ページタイトル
   - **API接続ステータスインジケータ**（緑＝接続中、赤＝エラー等）
   - スプレッドシートへのリンクボタン
   - 更新ボタン

2. **未申請アラートセクション**（v2.3）
   - 仕入れ状況が「未申請」のアイテムを赤枠で強調表示
   - 残数と発注ラインを明示

3. **仕入れ申請中セクション**（v2.3）
   - 仕入れ状況が「仕入れ申請中」のアイテムをオレンジ枠で表示
   - 到着待ちアイテムを明示

4. **サマリーカード**
   - 総アイテム数
   - 未申請アイテム数（赤）
   - 申請中アイテム数（オレンジ）
   - 完了アイテム数（緑）
   - 最終更新日時

5. **在庫一覧**
   - カテゴリ別グループ
   - 各カテゴリに未申請/申請中数バッジ
   - 在庫率バー（緑=完了/オレンジ=申請中/赤=未申請）
   - 仕入れ状況表示

6. **保管場所一覧**
   - 品名ごとの保管方法
   - 消費期限の目安

## 制約事項

- **読み取り専用**: ページからスプレッドシートの編集は不可
- **更新間隔**: API呼び出しは手動更新またはページ読み込み時のみ
- **認証**: GASはウェブアプリとして公開（閲覧は誰でも可）
- **データ遅延**: スプレッドシート更新後、数秒でAPIに反映

## セキュリティ

- スプレッドシートのIDはGAS側で管理
- APIエンドポイントはHTTPS
- 編集権限はスプレッドシート側で制御

## 拡張性ガイド v2.4

### 新しい商品を追加する場合

**手順**: スプレッドシートに行を追加するだけでOK

1. スプレッドシートの「在庫管理」シートに新しい行を追加
2. 列A〜Fに商品情報を入力
3. カテゴリと単位は自動判定される

**コード変更**: 不要

### 新しいカテゴリを追加する場合

**手順**: 2ファイルを更新

1. **GAS側** (`gas/inventory-api.js`)
   ```javascript
   const CATEGORY_RULES = {
     // ... 既存のカテゴリ ...
     '新カテゴリ名': ['キーワード1', 'キーワード2']  // 追加
   };
   ```

2. **クライアント側** (`data.js`)
   ```javascript
   const INVENTORY_CATEGORY_RULES = {
     // ... 既存のカテゴリ ...
     '新カテゴリ名': ['キーワード1', 'キーワード2']  // 追加
   };
   ```

3. GASを再デプロイ

### 新しい単位ルールを追加する場合

**手順**: 2ファイルを更新

1. **GAS側** (`gas/inventory-api.js`)
   ```javascript
   const UNIT_RULES = [
     // ... 既存のルール ...
     { pattern: '新パターン', unit: '新単位' }  // 追加
   ];
   ```

2. **クライアント側** (`data.js`)
   ```javascript
   const INVENTORY_UNIT_RULES = [
     // ... 既存のルール ...
     { pattern: '新パターン', unit: '新単位' }  // 追加
   ];
   ```

3. GASを再デプロイ

### フォールバックデータの更新

v2.4以降、フォールバックデータは自動生成されます。

- `fallbackInventoryData.items` に商品を追加するだけでOK
- `orderList`, `inProgressList`, `summary`, `categories` は自動生成
- `generateInventoryDerivedData()` 関数が初期化時に実行される

### 拡張時のチェックリスト

- [ ] スプレッドシートに商品を追加（基本操作）
- [ ] 新カテゴリの場合: CATEGORY_RULES を両ファイルで更新
- [ ] 新単位の場合: UNIT_RULES を両ファイルで更新
- [ ] GASを再デプロイ
- [ ] フォールバックデータに商品を追加（オフライン対応）

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 2.5 | 2025-12-30 | **単位ルール拡充**: コーヒー豆用パターン追加（ロースト、ブラジル、エスプレッソ豆）、サマリー0件表示を「-」に統一 |
| 2.4 | 2025-12-30 | **拡張性改善**: フォールバックデータ自動生成、UNIT_RULESテーブル化、拡張性ドキュメント追加 |
| 2.3 | 2025-12-30 | **仕入れ状況ベース判定**に変更（完了=緑、未申請=赤、仕入れ申請中=オレンジ）、statusType/inProgressフィールド追加、inProgressList追加 |
| 2.2 | 2025-12-30 | 単位推測ロジック修正（商品名のg/mlではなく商品タイプで判定: ソース→本、パウダー→袋など） |
| 2.1 | 2025-12-30 | カテゴリ分類ルール最適化（乳製品・冷蔵、衛生・清掃用品）、スポンジ・洗剤対応 |
| 2.0 | 2025-12-30 | 在庫管理シートを主データソースに変更、カテゴリ自動分類、在庫率表示、発注アラートセクション追加 |
| 1.0 | 2025-12-29 | 初版（在庫数・発注シート参照） |
