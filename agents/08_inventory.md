# 08_inventory.md - 在庫管理エージェント v2.0

## エージェント概要

| 項目 | 内容 |
|------|------|
| 役割 | 在庫管理システムの構築・保守 |
| 入力 | スプレッドシートURL、在庫データ構造 |
| 出力 | GASスクリプト、在庫表示UI |
| 責任範囲 | Google Spreadsheet連携、在庫状況の可視化 |
| バージョン | 2.0 |

## 対象スプレッドシート

- **URL**: https://docs.google.com/spreadsheets/d/1iuTiIGV0Zz-AMx8aTcKZ0qSfI6kUSnZT4RZnWbgDCB8/edit
- **メインデータソース**: `在庫管理`シート（v2.0で変更）
- **シート構成**:
  - `在庫管理`: **メイン在庫リスト**（商品名、仕入れ状況、残数、理想残数、初期仕入れ数、仕入れライン）
  - `在庫管理場所`: 保管場所情報（オプション）
  - `入力確認１`: 入力履歴（未使用）
  - `在庫数・発注`: 旧データソース（v1.0、非推奨）

## 在庫管理シート列構造

| 列 | インデックス | フィールド名 | 説明 | 例 |
|----|-------------|--------------|------|-----|
| A | 0 | name | 仕入れ品（商品名） | コーヒー豆（シティーローストブラジル） |
| B | 1 | purchaseStatus | 仕入れ状況 | 完了 |
| C | 2 | remaining | 残数 | 2500 |
| D | 3 | ideal | 理想残数 | 2000 |
| E | 4 | initial | 初期仕入れ数 | 3000 |
| F | 5 | orderLine | 仕入れライン（発注点） | 1000 |
| G〜 | 6〜 | - | 仕入れ日と数（履歴） | - |

## 発注判定ロジック

```javascript
// 残数が仕入れライン以下なら発注が必要
const needsOrder = orderLine > 0 && remaining <= orderLine;
const status = needsOrder ? '発注' : 'OK';

// 在庫率 = 残数 / 理想残数 × 100
const stockRatio = ideal > 0 ? Math.round((remaining / ideal) * 100) : 100;
```

## 技術仕様

### GAS（Google Apps Script）v2.0

1. **doGet関数**: Web APIとしてJSONを返す
2. **読み取り専用**: 編集機能は提供しない
3. **カテゴリ自動分類**: 商品名からカテゴリを推測
4. **在庫率計算**: 理想残数に対する割合を算出
5. **発注リスト生成**: 発注が必要なアイテムを別配列で提供

### カテゴリ分類ルール

```javascript
const CATEGORY_RULES = {
  'コーヒー': ['コーヒー豆', 'エスプレッソ'],
  '乳製品': ['牛乳', 'ホイップクリーム', 'ミルク', '氷'],
  'シロップ・ソース': ['チョコソース', 'キャラメルソース', 'バニラシロップ', 'チャイシロップ', 'ホワイトチョコソース'],
  'パウダー・茶葉': ['抹茶パウダー', 'ほうじ茶パウダー', 'アールグレイ'],
  '消耗品（容器）': ['紙カップ', 'フタ', 'プラカップ', 'プラフタ', 'マドラー', 'ストロー'],
  '消耗品（調味料）': ['シュガー', 'ガムシロップ'],
  '衛生用品': ['手袋', '消毒液', 'アルコール', 'ペーパータオル'],
  'その他': []
};
```

### フロントエンド

1. **在庫一覧表示**: カテゴリ別にグループ化
2. **発注アラートセクション**: 発注が必要なアイテムを先頭に表示
3. **在庫率バー**: 残数/理想残数の割合を視覚化
4. **3段階ステータス**: OK（緑）、残少（黄）、要発注（赤）
5. **API接続ステータス表示**: リアルタイムで接続状態を視覚的に表示

### API接続ステータス機能

ページヘッダーに接続状態をリアルタイム表示:

| ステータス | インジケータ | 意味 |
|-----------|-------------|------|
| `connected` | 緑（点滅） | API正常接続中 |
| `checking` | オレンジ（点滅） | 接続確認中 |
| `cached` | 青 | キャッシュデータ使用中 |
| `offline` | 赤 | 接続エラー |
| `unconfigured` | グレー | API未設定（デモデータ） |

## データ構造 v2.0

### 在庫アイテム（新形式）
```javascript
{
  name: "コーヒー豆（シティーローストブラジル）",
  category: "コーヒー",           // 自動分類
  remaining: 2500,                // 残数
  ideal: 2000,                    // 理想残数
  initial: 3000,                  // 初期仕入れ数
  orderLine: 1000,                // 仕入れライン（発注点）
  purchaseStatus: "完了",         // 仕入れ状況
  status: "OK",                   // 発注判定結果
  needsOrder: false,              // 発注フラグ
  stockRatio: 125,                // 在庫率（%）
  unit: "g"                       // 単位（自動推測）
}
```

### APIレスポンス構造
```javascript
{
  success: true,
  timestamp: "2025-12-30T01:30:00.000Z",
  version: "2.0",
  summary: {
    totalItems: 24,
    needsOrder: 2,
    lowStock: 5,
    okItems: 17
  },
  items: [...],           // 全在庫アイテム
  categories: {...},      // カテゴリ別グループ（発注優先ソート済み）
  orderList: [...],       // 発注が必要なアイテムリスト
  storage: [...]          // 保管場所情報
}
```

### 保管情報
```javascript
{
  name: "チョコソース",
  beforeOpen: "常温",
  afterOpen: "閉店時：冷蔵庫\n開店時：常温",
  location: "",
  expiryDays: "1か月",
  notes: "注ぎ口を清潔に"
}
```

## UI設計 v2.0

### 在庫管理ページ構成

1. **ヘッダー**
   - ページタイトル
   - **API接続ステータスインジケータ**（緑＝接続中、赤＝エラー等）
   - スプレッドシートへのリンクボタン
   - 更新ボタン

2. **発注アラートセクション**（新機能）
   - 発注が必要なアイテムを赤枠で強調表示
   - 残数と発注ラインを明示

3. **サマリーカード**
   - 総アイテム数
   - 発注が必要なアイテム数
   - 残少アイテム数
   - 最終更新日時

4. **在庫一覧**
   - カテゴリ別グループ
   - 各カテゴリに要発注数バッジ
   - 在庫率バー（緑/黄/赤）
   - 仕入れ状況表示

5. **保管場所一覧**
   - 品名ごとの保管方法
   - 消費期限の目安

## 制約事項

- **読み取り専用**: ページからスプレッドシートの編集は不可
- **更新間隔**: API呼び出しは手動更新またはページ読み込み時のみ
- **認証**: GASはウェブアプリとして公開（閲覧は誰でも可）
- **データ遅延**: スプレッドシート更新後、数秒でAPIに反映

## セキュリティ

- スプレッドシートのIDはGAS側で管理
- APIエンドポイントはHTTPS
- 編集権限はスプレッドシート側で制御

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 2.0 | 2025-12-30 | 在庫管理シートを主データソースに変更、カテゴリ自動分類、在庫率表示、発注アラートセクション追加 |
| 1.0 | 2025-12-29 | 初版（在庫数・発注シート参照） |
